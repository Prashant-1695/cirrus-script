#!/bin/bash

cd /tmp
. /tmp/ci/function

# disable ccache upload if rom compilation was successful
if [ ! -e /tmp/rom/out/target/product/$device_codename/*$device_codename*2022*zip ]; then

# compress in with pigz in a single zip.
com ccache 1 # Compression level 1, its enough

mv *.tar.gz /tmp/$rom_name

echo "|| Uploading CCACHE ||"
cd /tmp/$rom_name
git add -f -A .
git commit -sm "CCACHE: IMPORT CCACHE FROM NEW BUILD"
git push -f

# lets compile again as rom isn't ready yet
git clone -b $CIRRUS_BRANCH $github_repo $rom_name && cd $rom_name
git commit -sm "SH*T, HERE WE GO AGAIN" --allow-empty
git push -f

else

# drop empty commits
git clone -b $CIRRUS_BRANCH $github_repo $rom_name && cd $rom_name
git filter-branch --commit-filter 'git_commit_non_empty_tree "$@"' -f HEAD
git commit -sm "ci: droping prev empty commits [skip ci]" -m "* now you can have successfull on just one commit
* make sure to put R letter at the end of commit messages
* lik git commit -m your_msg R" --allow-empty
git push -f

fi

# clean storage
rm -rf /tmp/*
